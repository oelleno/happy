<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="language" content="ko">
    <script type="module" src="./firebase.js"></script>
    <title>ê³„ì•½ì„œ ì„ íƒ</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <style>
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 250px;
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.show {
            opacity: 1;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin-top: -150px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .card-body {
            padding: 2rem;
        }

        .btn-contract {
            width: 100%;
            margin-bottom: 1rem;
            padding: 1rem;
            font-size: 1.1rem;
        }

        #verification-section,
        #admin-section {
            display: none;
        }
    </style>
</head>

<body>
    <script>
        localStorage.clear(); // ëª¨ë“  localStorage ë°ì´í„° ì‚­ì œ

        // Function to show in-page notification
        function showNotification(message, type) {
            // Check if notification element already exists
            let notification = document.getElementById('notification');

            // If not, create it
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = 'alert alert-info';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.padding = '12px 20px';
                notification.style.borderRadius = '5px';
                notification.style.zIndex = '9999';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease-in-out';
                notification.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
                notification.style.textAlign = 'center';
                notification.style.minWidth = '250px';
                document.body.appendChild(notification);
            }

            // Set notification content
            notification.innerHTML = `<p class="mb-2"><strong>${message}</strong></p>`;

            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);

            // Hide after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
        }
    </script>

    <div class="container">
        <div class="card">
            <div class="card-body">
                <div id="contract-selection">
                    <h2 class="text-center mb-4">ê³„ì•½ì„œ ì„ íƒ</h2>
                    <button class="btn btn-primary btn-contract" onclick="showVerification()">íšŒì›ê°€ì…ê³„ì•½ì„œ</button>
                    <button class="btn btn-secondary btn-contract" disabled>PTê³„ì•½ì„œ (ì¤€ë¹„ì¤‘)</button>
                    <button class="btn btn-secondary btn-contract" disabled>ì¼ì¼ê¶Œê³„ì•½ì„œ (ì¤€ë¹„ì¤‘)</button>
                </div>

                <script>
                    function showVerification() {
                        document.getElementById('contract-selection').style.display = 'none';
                        document.getElementById('verification-section').style.display = 'block';
                    }
                </script>

                <div id="verification-section">
                    <h2 class="text-center mb-4">ì „í™”ë²ˆí˜¸ ì¸ì¦</h2>
                    <div id="phone-section" class="mb-3">
                        <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                        <div class="input-group">
                            <span class="input-group-text">+82</span>
                            <input type="tel" inputmode="tel" pattern="[0-9]*" class="form-control" id="phone"
                                placeholder="01012341234">
                        </div>
                        <button id="send-code" class="btn btn-primary mt-3 w-100">ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
                    </div>
                    <div id="verification-code-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">ì¸ì¦ë²ˆí˜¸</label>
                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control" id="verification-code" placeholder="4ìë¦¬ ì½”ë“œ ì…ë ¥"
                                    inputmode="tel" lang="ko">
                                <span id="timer" class="ms-2 badge"
                                    style="height: 38px; display: flex; align-items: center; font-size: 14px; background-color: #6610f2 !important; color: white;">3:00</span>
                            </div>
                            <button id="verify-code" class="btn btn-success mt-3 w-100">ì¸ì¦í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <p></p>
                        <button id="admin-button" onclick="showAdminSection()" class="btn btn-secondary">ê´€ë¦¬ìì½”ë“œ
                            ì…ë ¥</button>
                    </div>
                    <div id="verification-success" style="display: none;" class="alert alert-success mt-3">
                        ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
                    </div>
                </div>

                <div id="admin-section">
                    <h2 class="text-center mb-4">ê´€ë¦¬ì ì¸ì¦</h2>
                    <div class="mb-3">
                        <label class="form-label">ê´€ë¦¬ì ì½”ë“œ</label>
                        <input type="password" class="form-control" id="admin-code">
                        <button onclick="verifyAdmin()" class="btn btn-primary mt-3 w-100">í™•ì¸</button>
                        <div id="user-info" class="alert mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyP5QTMzBtz8lMEzkE4C66CjFbZ3a17QM",
            authDomain: "bodystar-1b77d.firebaseapp.com",
            projectId: "bodystar-1b77d",
            storageBucket: "bodystar-1b77d.firebasestorage.app",
            messagingSenderId: "1011822927832",
            appId: "1:1011822927832:web:87f0d859b3baf1d8e21cad"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        auth.languageCode = "ko";

        // Function moved up to the onclick handler

        let verificationId = '';

        let timerInterval;

        function startTimer(duration, display) {
            let timer = duration;
            let minutes, seconds;

            clearInterval(timerInterval); // Clear any existing timer

            timerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    display.textContent = "ë§Œë£Œë¨";
                    display.classList.remove("bg-danger");
                    display.classList.add("bg-secondary");

                    // Disable verification and show resend button
                    document.getElementById('verification-code').disabled = true;
                    document.getElementById('verify-code').disabled = true;

                    // Add resend button if it doesn't exist
                    if (!document.getElementById('resend-code')) {
                        const resendBtn = document.createElement('button');
                        resendBtn.id = 'resend-code';
                        resendBtn.className = 'btn btn-warning mt-2 w-100';
                        resendBtn.textContent = 'ì¸ì¦ë²ˆí˜¸ ì¬ë°œì†¡';
                        resendBtn.onclick = function () {
                            document.getElementById('send-code').click();
                        };
                        document.getElementById('verification-code-section').querySelector('.mb-3').appendChild(resendBtn);
                    }

                    // Invalidate the auth code
                    window.authCode = null;
                }
            }, 1000);
        }

        document.getElementById('send-code').addEventListener('click', async () => {
            const phone = document.getElementById('phone').value;
            if (!phone) return;

            const authCode = Math.floor(1000 + Math.random() * 9000);
            const íšŒì‚¬ëª… = 'ë°”ë””ìŠ¤íƒ€';

            const params = new URLSearchParams({
                'apikey': 'lcrmiph2rvyuaqiq1qp3lbs332di0x95',
                'userid': 'bodystar',
                'senderkey': 'b4c886fa9bd3cbf1faddb759fa6532867844ef03',
                'tpl_code': 'TY_3472',
                'sender': '01092792273',
                'receiver_1': phone,
                'subject_1': 'ì¸ì¦ë²ˆí˜¸ë°œì†¡',
                'message_1': `[${íšŒì‚¬ëª…}] ë³¸ì¸ í™•ì¸ì„ ìœ„í•œ ì¸ì¦ë²ˆí˜¸ëŠ” ${authCode}ì…ë‹ˆë‹¤.`,
            });

            try {
                const response = await fetch('https://kakaoapi.aligo.in/akv10/alimtalk/send/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params
                });

                const data = await response.json();
                if (data.result_code === "1" || data.message === "ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ìš”ì²­ í•˜ì˜€ìŠµë‹ˆë‹¤.") {
                    document.getElementById('verification-code-section').style.display = 'block';
                    document.getElementById('phone-section').style.display = 'none';
                    document.getElementById('admin-button').style.display = 'none';

                    // Remove resend button if it exists
                    const resendBtn = document.getElementById('resend-code');
                    if (resendBtn) resendBtn.remove();

                    // Enable verification inputs
                    document.getElementById('verification-code').disabled = false;
                    document.getElementById('verification-code').value = '';
                    document.getElementById('verify-code').disabled = false;

                    // Reset timer display
                    const timerDisplay = document.getElementById('timer');
                    timerDisplay.textContent = "3:00";
                    timerDisplay.classList.remove("bg-secondary");
                    timerDisplay.classList.add("bg-danger");

                    // Start the countdown timer (3 minutes)
                    startTimer(180, timerDisplay);

                    window.authCode = authCode;
                    // Create in-page notification
                    showNotification("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                } else {
                    showNotification(`ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì‹¤íŒ¨: ${data.message}`, "error");
                }
            } catch (error) {
                console.error(error);
                showNotification('ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì‹¤íŒ¨', "error");
            }
        });

        document.getElementById('verify-code').addEventListener('click', () => {
            const code = document.getElementById('verification-code').value;
            if (!code) return;

            // Check if the timer is still valid
            const timerDisplay = document.getElementById('timer');
            if (timerDisplay.textContent === "ë§Œë£Œë¨") {
                alert('ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ë°œì†¡í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (window.authCode && code === window.authCode.toString()) {
                // Stop the timer
                clearInterval(timerInterval);

                const phoneNumber = document.getElementById('phone').value;
                const formattedPhone = phoneNumber.replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-$2-$3');
                localStorage.setItem('verifiedPhone', formattedPhone);

                document.getElementById('phone-section').style.display = 'none';
                document.getElementById('verification-code-section').style.display = 'none';
                document.getElementById('verification-success').style.display = 'block';

                // Check if user is existing member
                checkExistingMember(formattedPhone);
            } else {
                alert('ì˜ëª»ëœ ì¸ì¦ë²ˆí˜¸ì…ë‹ˆë‹¤.');
            }
        });

        // Function to check if the user is an existing member and handle accordingly
        async function checkExistingMember(phoneNumber) {
            try {
                const querySnapshot = await db.collection("Membership").get();
                let memberFound = false;
                let memberData = null;

                querySnapshot.forEach((doc) => {
                    if (doc.data().contact === phoneNumber) {
                        memberFound = true;
                        memberData = doc.data();
                    }
                });

                // Display member info in the verification section if found
                document.getElementById('verification-success').style.display = 'none';

                const memberInfoDiv = document.createElement('div');
                memberInfoDiv.className = 'mt-3';
                memberInfoDiv.style.textAlign = 'center';

                if (memberFound) {
                    memberInfoDiv.innerHTML = `
                        <div class="alert alert-info">
                            <p class="mb-2"><strong>ê¸°ì¡´ íšŒì›ì…ë‹ˆë‹¤!</strong></p>
                            <p class="mb-1">ì´ë¦„: ${memberData.name}</p>
                            <p class="mb-3">ìƒë…„ì›”ì¼: ${memberData.birthdate}</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="window.location.href='membership.html?phone=${phoneNumber}&load=true'" class="btn btn-success">ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                <button onclick="window.location.href='membership.html'" class="btn btn-primary">ì‹ ê·œ ì…ë ¥</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Redirect to membership page for new members after a short delay
                    memberInfoDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <p class="mb-2"><strong>ì‹ ê·œ ê³ ê°ì…ë‹ˆë‹¤!</strong></p>
                            <p class="mb-3">íšŒì›ê°€ì… í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.href = 'membership.html';
                    }, 1500);
                }

                // Add the member info display to the verification section
                const verificationSection = document.getElementById('verification-section');
                if (verificationSection.querySelector('.member-info-display')) {
                    verificationSection.querySelector('.member-info-display').remove();
                }
                memberInfoDiv.classList.add('member-info-display');
                verificationSection.appendChild(memberInfoDiv);

            } catch (error) {
                console.error("Error checking member:", error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'membership.html';
            }
        }

        function showAdminSection() {
            document.getElementById('verification-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
        }

        async function getAdminCodeFromFirestore() {
            try {
                const response = await fetch("https://us-central1-bodystar-1b77d.cloudfunctions.net/getAdminCode", {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    return String(result.adminCode).trim(); 
                } else {
                    console.error("ê´€ë¦¬ì ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", result.error);
                    return null;
                }
            } catch (error) {
                console.error("API í˜¸ì¶œ ì˜¤ë¥˜:", error);
                return null;
            }
        }


        async function verifyAdmin() {
            const adminCodeInput = document.getElementById('admin-code').value;
            const storedAdminCode = await getAdminCodeFromFirestore();

            if (!storedAdminCode) {
                alert("âš  ê´€ë¦¬ì ì½”ë“œ ì„¤ì •ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                return;
            }

            if (adminCodeInput === storedAdminCode) {
                alert("âœ… ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ!");
                // ğŸš€ ê¸°ì¡´ `checkExistingMember(localStorage.getItem('verifiedPhone'))` ì‚­ì œ
                window.location.href = "membership.html"; // ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ íšŒì› ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
            } else {
                alert("âŒ ì˜ëª»ëœ ê´€ë¦¬ì ì½”ë“œì…ë‹ˆë‹¤.");
            }
        }


        function loadMemberData(phone) {
            window.location.href = `membership.html?phone=${phone}&load=true`;
        }

        // Add Enter key functionality
        document.getElementById('phone').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('send-code').click();
            }
        });

        document.getElementById('verification-code').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('verify-code').click();
            }
        });

        document.getElementById('admin-code').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                verifyAdmin();
            }
        });
    </script>
</body>

</html>